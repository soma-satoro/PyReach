{% extends "wiki/base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Page{% endblock %}

{% block extra_head %}
<!-- Include SimpleMDE Markdown Editor -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<style>
.editor-toolbar {
    background: var(--color-bg-tertiary);
    border-color: var(--color-border);
}

.editor-toolbar a {
    color: var(--color-text-secondary) !important;
}

.editor-toolbar a:hover,
.editor-toolbar a.active {
    background: var(--color-bg-hover);
    border-color: var(--color-border-light);
    color: var(--color-accent-gold) !important;
}

.CodeMirror {
    background: var(--color-bg-tertiary);
    color: var(--color-text-primary);
    border-color: var(--color-border);
    font-family: var(--font-serif);
    font-size: 1.05rem;
    line-height: 1.8;
    height: auto;
    min-height: 400px;
}

.CodeMirror-cursor {
    border-left-color: var(--color-accent-purple);
}

.editor-preview {
    background: var(--color-bg-secondary);
    color: var(--color-text-secondary);
}

.editor-preview h1,
.editor-preview h2,
.editor-preview h3 {
    color: var(--color-accent-gold);
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="card">
        <div class="card-header">
            <h1 style="margin: 0;">
                <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus{% endif %}"></i>
                {% if form.instance.pk %}Edit Page: {{ form.instance.title }}{% else %}Create New Page{% endif %}
            </h1>
        </div>
        <div class="card-body">
            <form method="post" id="page-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-error">
                    {{ form.non_field_errors }}
                </div>
                {% endif %}

                <!-- Title -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.title.id_for_label }}">
                        <i class="fas fa-heading"></i> Title *
                    </label>
                    {{ form.title }}
                    {% if form.title.errors %}
                    <div class="alert alert-error" style="margin-top: 0.5rem;">
                        {{ form.title.errors }}
                    </div>
                    {% endif %}
                    <small class="form-help">The title of your wiki page</small>
                </div>

                <!-- Slug -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.slug.id_for_label }}">
                        <i class="fas fa-link"></i> URL Slug
                    </label>
                    {{ form.slug }}
                    {% if form.slug.errors %}
                    <div class="alert alert-error" style="margin-top: 0.5rem;">
                        {{ form.slug.errors }}
                    </div>
                    {% endif %}
                    <small class="form-help">Leave blank to auto-generate from title</small>
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.category.id_for_label }}">
                        <i class="fas fa-folder"></i> Category
                    </label>
                    {{ form.category }}
                    {% if form.category.errors %}
                    <div class="alert alert-error" style="margin-top: 0.5rem;">
                        {{ form.category.errors }}
                    </div>
                    {% endif %}
                    <small class="form-help">Select a category for this page</small>
                </div>

                <!-- Summary -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.summary.id_for_label }}">
                        <i class="fas fa-align-left"></i> Summary
                    </label>
                    {{ form.summary }}
                    {% if form.summary.errors %}
                    <div class="alert alert-error" style="margin-top: 0.5rem;">
                        {{ form.summary.errors }}
                    </div>
                    {% endif %}
                    <small class="form-help">Brief description (auto-generated if left blank)</small>
                </div>

                <!-- Content -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.content.id_for_label }}">
                        <i class="fas fa-file-alt"></i> Content *
                    </label>
                    {{ form.content }}
                    {% if form.content.errors %}
                    <div class="alert alert-error" style="margin-top: 0.5rem;">
                        {{ form.content.errors }}
                    </div>
                    {% endif %}
                    <small class="form-help">Supports Markdown formatting</small>
                </div>

                <!-- Tags -->
                <div class="form-group">
                    <label class="form-label" for="{{ form.tags.id_for_label }}">
                        <i class="fas fa-tags"></i> Tags
                    </label>
                    {{ form.tags }}
                    {% if form.tags.errors %}
                    <div class="alert alert-error" style="margin-top: 0.5rem;">
                        {{ form.tags.errors }}
                    </div>
                    {% endif %}
                    <small class="form-help">Comma-separated tags (e.g., "lore, faction, vampire")</small>
                </div>

                <!-- Publishing Options -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-cog"></i> Publishing Options
                    </label>
                    
                    <div class="form-check">
                        {{ form.published }}
                        <label class="form-check-label" for="{{ form.published.id_for_label }}">
                            Published (visible to players)
                        </label>
                    </div>
                    
                    <div class="form-check">
                        {{ form.staff_only }}
                        <label class="form-check-label" for="{{ form.staff_only.id_for_label }}">
                            Staff Only (only visible to staff members)
                        </label>
                    </div>
                    
                    <div class="form-check">
                        {{ form.featured }}
                        <label class="form-check-label" for="{{ form.featured.id_for_label }}">
                            Featured (show on home page)
                        </label>
                    </div>
                </div>

                {% if form.instance.pk %}
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-comment"></i> Revision Summary
                    </label>
                    <input type="text" name="revision_summary" class="form-control" 
                           placeholder="Brief description of your changes">
                    <small class="form-help">Optional note about what you changed</small>
                </div>
                {% endif %}

                <!-- Buttons -->
                <div class="flex gap-2" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> 
                        {% if form.instance.pk %}Update Page{% else %}Create Page{% endif %}
                    </button>
                    <button type="button" id="preview-btn" class="btn btn-secondary btn-lg">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <a href="{% if form.instance.pk %}{% url 'wiki:page' form.instance.slug %}{% else %}{% url 'wiki:index' %}{% endif %}" 
                       class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Area -->
    <div id="preview-area" class="card" style="margin-top: 2rem; display: none;">
        <div class="card-header">
            <h2 style="margin: 0;"><i class="fas fa-eye"></i> Preview</h2>
        </div>
        <div class="card-body wiki-article-content">
            <!-- Preview content will be inserted here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
$(document).ready(function() {
    // Initialize SimpleMDE Markdown Editor
    var simplemde = new SimpleMDE({
        element: document.getElementById("id_content"),
        spellChecker: false,
        placeholder: "Write your wiki content here...\n\nMarkdown formatting is supported:\n\n# Heading 1\n## Heading 2\n**bold** *italic*\n- List item\n[Link text](url)\n\n> Blockquote",
        status: ["lines", "words", "cursor"],
        toolbar: [
            "bold", "italic", "heading", "|",
            "quote", "unordered-list", "ordered-list", "|",
            "link", "image", "|",
            "preview", "side-by-side", "fullscreen", "|",
            "guide"
        ],
        renderingConfig: {
            codeSyntaxHighlighting: true
        },
        previewRender: function(plainText) {
            // Custom preview rendering
            return this.parent.markdown(plainText);
        }
    });

    // Auto-generate slug from title
    $('#id_title').on('input', function() {
        if ($('#id_slug').val() === '' || $('#id_slug').data('auto-generated')) {
            var slug = $(this).val()
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '');
            $('#id_slug').val(slug).data('auto-generated', true);
        }
    });

    // Remove auto-generated flag if user manually edits slug
    $('#id_slug').on('input', function() {
        if ($(this).val() !== '') {
            $(this).data('auto-generated', false);
        }
    });

    // Preview button
    $('#preview-btn').on('click', function(e) {
        e.preventDefault();
        var content = simplemde.value();
        
        if (!content.trim()) {
            alert('Please enter some content to preview.');
            return;
        }
        
        // Show loading
        $('#preview-area').show();
        $('#preview-area .card-body').html('<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Generating preview...</p>');
        
        $.ajax({
            url: '/wiki/ajax/preview/',
            method: 'POST',
            data: {
                content: content,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                $('#preview-area .card-body').html(response.html);
                // Scroll to preview
                $('html, body').animate({
                    scrollTop: $('#preview-area').offset().top - 100
                }, 600);
            },
            error: function() {
                $('#preview-area .card-body').html('<div class="alert alert-error">Error generating preview</div>');
            }
        });
    });

    // Form validation
    $('#page-form').on('submit', function(e) {
        var title = $('#id_title').val().trim();
        var content = simplemde.value().trim();
        
        if (!title) {
            alert('Please enter a title for the page.');
            $('#id_title').focus();
            e.preventDefault();
            return false;
        }
        
        if (!content) {
            alert('Please enter some content for the page.');
            simplemde.codemirror.focus();
            e.preventDefault();
            return false;
        }
        
        return true;
    });
});
</script>
{% endblock %}

